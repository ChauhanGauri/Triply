<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || "Admin Dashboard - Booking Management" %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: #1E293B;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1E293B;
    }

    .dashboard-container {
      background: #FFFFFF;
      min-height: 100vh;
      border-radius: 20px 0 0 20px;
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.8s ease-out;
    }

    .dashboard-header {
      background: #1E293B;
      color: white;
      padding: 2rem 0;
      border-radius: 20px 0 0 0;
    }

    .dashboard-title {
      background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .stat-card {
      background: #FFFFFF;
      border: 2px solid #F1F5F9;
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      transition: width 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(30, 41, 59, 0.12);
      border-color: #F59E0B;
    }

    .stat-card:hover::before {
      width: 6px;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: #64748B;
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-card {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
      border: 1px solid #F1F5F9;
    }

    .section-title {
      color: #1E293B;
      font-weight: 600;
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
    }

    .btn-custom {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-custom:hover {
      background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
      color: white;
      text-decoration: none;
    }

    .btn-outline-custom {
      background: transparent;
      border: 2px solid #F59E0B;
      color: #F59E0B;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-outline-custom:hover {
      background: #F59E0B;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
      text-decoration: none;
    }

    .table {
      background: #FFFFFF;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
    }

    .table thead th {
      background: #F8FAFC;
      border-bottom: 2px solid #E2E8F0;
      color: #1E293B;
      font-weight: 600;
      padding: 1rem;
    }

    .table tbody td {
      padding: 1rem;
      border-bottom: 1px solid #F1F5F9;
      color: #475569;
    }

    .table-hover tbody tr:hover {
      background-color: #FEF3C7;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-confirmed {
      background: #D1FAE5;
      color: #065F46;
    }

    .status-pending {
      background: #FED7AA;
      color: #9A3412;
    }

    .status-cancelled {
      background: #FECACA;
      color: #B91C1C;
    }

    @keyframes slideIn {
      0% {
        opacity: 0;
        transform: translateX(30px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        border-radius: 0;
        margin: 0;
      }

      .dashboard-header {
        border-radius: 0;
        text-align: center;
      }

      .stat-card {
        margin-bottom: 1rem;
      }
    }
  </style>
</head>
<body>

  <div class="container-fluid p-0">
    <div class="row g-0 min-vh-100">
      <!-- Main Content -->
      <div class="col dashboard-container">

        <!-- Header -->
        <div class="dashboard-header">
          <div class="container">
            <div class="row align-items-center">
              <div class="col">
                <a href="/admin/dashboard" class="text-decoration-none">
                  <h1 class="dashboard-title mb-1">
                    <i class="bi bi-bus-front me-3"></i>
                    Triply
                  </h1>
                </a>
                <p class="mb-0 opacity-75">Admin Dashboard</p>
              </div>
              <div class="col-auto">
                <div class="d-flex gap-2 flex-wrap">
                  <a href="/admin/bookings" class="btn-custom">
                    <i class="bi bi-ticket-detailed"></i>
                    Bookings
                  </a>
                  <a href="/admin/routes" class="btn-custom">
                    <i class="bi bi-map"></i>
                    Routes
                  </a>
                  <a href="/admin/schedules" class="btn-custom">
                    <i class="bi bi-calendar-event"></i>
                    Schedules
                  </a>
                  <a href="/admin/users" class="btn-custom">
                    <i class="bi bi-people"></i>
                    Users
                  </a>
                  <a href="/auth/logout" class="btn-outline-custom">
                    <i class="bi bi-box-arrow-right"></i>
                    Logout
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="container py-4">

          <!-- Statistics Cards -->
          <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100">
                <div class="stat-icon">
                  <i class="bi bi-ticket-detailed"></i>
                </div>
                <div class="stat-value"><%= data.stats.totalBookings %></div>
                <div class="stat-label">Total Bookings</div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100">
                <div class="stat-icon">
                  <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-value"><%= data.stats.confirmedBookings %></div>
                <div class="stat-label">Confirmed</div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100">
                <div class="stat-icon">
                  <i class="bi bi-x-circle"></i>
                </div>
                <div class="stat-value"><%= data.stats.cancelledBookings %></div>
                <div class="stat-label">Cancelled</div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100">
                <div class="stat-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="stat-value"><%= data.stats.totalUsers %></div>
                <div class="stat-label">Total Users</div>
              </div>
            </div>
          </div>

          <!-- Recent Bookings Section -->
          <div class="section-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="section-title mb-0">
                <i class="bi bi-clock-history me-2"></i>
                Recent Bookings
              </h2>
              <a href="/admin/bookings" class="btn-custom">
                <i class="bi bi-arrow-right"></i>
                View All
              </a>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Booking ID</th>
                    <th>Customer</th>
                    <th>Route</th>
                    <th>Seats</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (data.recentBookings && data.recentBookings.length > 0) { %>
                    <% data.recentBookings.forEach(booking => { %>
                      <tr>
                        <td><code>#<%= booking._id.toString().slice(-6) %></code></td>
                        <td>
                          <div>
                            <strong><%= booking.user ? booking.user.name : 'Unknown User' %></strong>
                            <br><small class="text-muted"><%= booking.user ? booking.user.email : 'N/A' %></small>
                          </div>
                        </td>
                        <td>
                          <% if (booking.schedule && booking.schedule.route) { %>
                            <strong><%= booking.schedule.route.routeNumber %></strong>
                            <br><small class="text-muted"><%= booking.schedule.route.origin %> → <%= booking.schedule.route.destination %></small>
                          <% } else { %>
                            <span class="text-muted">Route not found</span>
                          <% } %>
                        </td>
                        <td><span class="badge bg-info"><%= booking.seats %> seat(s)</span></td>
                        <td>
                          <% if (booking.status === 'confirmed') { %>
                            <span class="status-badge status-confirmed">Confirmed</span>
                          <% } else if (booking.status === 'cancelled') { %>
                            <span class="status-badge status-cancelled">Cancelled</span>
                          <% } else { %>
                            <span class="status-badge status-pending"><%= booking.status %></span>
                          <% } %>
                        </td>
                        <td><small><%= new Date(booking.createdAt).toLocaleDateString() %></small></td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" title="View Details">
                              <i class="bi bi-eye"></i>
                            </button>
                            <% if (booking.status === 'confirmed') { %>
                              <button class="btn btn-outline-danger btn-sm" title="Cancel Booking"
                                      onclick="cancelBooking('<%= booking._id %>')">
                                <i class="bi bi-x-circle"></i>
                              </button>
                            <% } %>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="7" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox"></i> No recent bookings found
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Management Modules -->
          <div class="row">
            <div class="col-12">
              <h2 class="section-title mb-4">
                <i class="bi bi-gear me-2"></i>
                Management Modules
              </h2>
            </div>

            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100 text-center">
                <div class="stat-icon">
                  <i class="bi bi-ticket-detailed"></i>
                </div>
                <h5 class="mt-3 mb-3">Booking Management</h5>
                <p class="text-muted mb-4">Manage customer bookings, view reservations, and handle cancellations</p>
                <div class="d-grid gap-2">
                  <a href="/admin/bookings" class="btn-custom">
                    <i class="bi bi-list-ul me-2"></i>
                    View All Bookings
                  </a>
                  <a href="/admin/bookings/new" class="btn-outline-custom">
                    <i class="bi bi-plus-circle me-2"></i>
                    New Booking
                  </a>
                </div>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100 text-center">
                <div class="stat-icon">
                  <i class="bi bi-map"></i>
                </div>
                <h5 class="mt-3 mb-3">Route Management</h5>
                <p class="text-muted mb-4">Create and manage transport routes, set origins and destinations</p>
                <div class="d-grid gap-2">
                  <a href="/admin/routes" class="btn-custom">
                    <i class="bi bi-list-ul me-2"></i>
                    View All Routes
                  </a>
                  <a href="/admin/routes/new" class="btn-outline-custom">
                    <i class="bi bi-plus-circle me-2"></i>
                    New Route
                  </a>
                </div>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100 text-center">
                <div class="stat-icon">
                  <i class="bi bi-calendar-event"></i>
                </div>
                <h5 class="mt-3 mb-3">Schedule Management</h5>
                <p class="text-muted mb-4">Manage bus schedules, departure times, and journey dates</p>
                <div class="d-grid gap-2">
                  <a href="/admin/schedules" class="btn-custom">
                    <i class="bi bi-list-ul me-2"></i>
                    View All Schedules
                  </a>
                  <a href="/admin/schedules/new" class="btn-outline-custom">
                    <i class="bi bi-plus-circle me-2"></i>
                    New Schedule
                  </a>
                </div>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-4">
              <div class="stat-card h-100 text-center">
                <div class="stat-icon">
                  <i class="bi bi-people"></i>
                </div>
                <h5 class="mt-3 mb-3">User Management</h5>
                <p class="text-muted mb-4">Manage customers and admin users, handle permissions</p>
                <div class="d-grid gap-2">
                  <a href="/admin/users" class="btn-custom">
                    <i class="bi bi-list-ul me-2"></i>
                    View All Users
                  </a>
                  <a href="/admin/users/new" class="btn-outline-custom">
                    <i class="bi bi-plus-circle me-2"></i>
                    New User
                  </a>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Booking Modal -->
  <div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cancel Booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to cancel this booking? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="confirmCancel">Cancel Booking</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let bookingToCancel = null;

    function cancelBooking(bookingId) {
      bookingToCancel = bookingId;
      new bootstrap.Modal(document.getElementById('cancelModal')).show();
    }

    document.getElementById('confirmCancel').addEventListener('click', async function() {
      if (bookingToCancel) {
        try {
          const response = await fetch(`/api/bookings/${bookingToCancel}/cancel`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            location.reload(); // Refresh the page to show updated data
          } else {
            alert('Failed to cancel booking. Please try again.');
          }
        } catch (error) {
          alert('Error cancelling booking. Please try again.');
        }

        bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
      }
    });
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    try {
      const socket = io();
      // Join admin room for real-time admin updates
      socket.emit('joinRoom', 'admins');

      socket.on('bookingCreated', (payload) => {
        try {
          const booking = payload.booking;
          const tbody = document.querySelector('.table.table-hover tbody');
          if (!tbody) return;

          // Create row markup similar to server-rendered rows
          const tr = document.createElement('tr');
          const idCell = `<td><code>#${booking._id.toString().slice(-6)}</code></td>`;
          const userName = booking.user ? (booking.user.name || 'Unknown User') : 'Unknown User';
          const userEmail = booking.user ? (booking.user.email || 'N/A') : 'N/A';
          const customerCell = `<td><div><strong>${escapeHtml(userName)}</strong><br><small class="text-muted">${escapeHtml(userEmail)}</small></div></td>`;

          let routeHtml = '<td><span class="text-muted">Route not found</span></td>';
          if (booking.schedule && booking.schedule.route) {
            routeHtml = `<td><strong>${escapeHtml(booking.schedule.route.routeNumber || '')}</strong><br><small class="text-muted">${escapeHtml(booking.schedule.route.origin || '')} → ${escapeHtml(booking.schedule.route.destination || '')}</small></td>`;
          }

          const seatsCell = `<td><span class="badge bg-info">${booking.seats || 1} seat(s)</span></td>`;

          let statusBadge = `<span class="status-badge status-pending">${escapeHtml(booking.status || 'pending')}</span>`;
          if (booking.status === 'confirmed') statusBadge = '<span class="status-badge status-confirmed">Confirmed</span>';
          if (booking.status === 'cancelled') statusBadge = '<span class="status-badge status-cancelled">Cancelled</span>';

          const statusCell = `<td>${statusBadge}</td>`;
          const dateCell = `<td><small>${new Date(booking.createdAt).toLocaleDateString()}</small></td>`;

          const actionsCell = `<td><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary btn-sm" title="View Details"><i class="bi bi-eye"></i></button>${booking.status === 'confirmed' ? `<button class="btn btn-outline-danger btn-sm" title="Cancel Booking" onclick="cancelBooking('${booking._id}')"><i class="bi bi-x-circle"></i></button>` : ''}</div></td>`;

          tr.innerHTML = idCell + customerCell + routeHtml + seatsCell + statusCell + dateCell + actionsCell;

          // Prepend new booking to top of list
          if (tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild);
          else tbody.appendChild(tr);
        } catch (err) {
          console.error('Error handling bookingCreated payload:', err);
        }
      });

      function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str).replace(/[&<>"'`]/g, function (s) {
          return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '`': '&#x60;'
          })[s];
        });
      }
    } catch (socketErr) {
      console.warn('Socket.io client failed to initialize:', socketErr.message);
    }
  </script>
</body>
</html>
