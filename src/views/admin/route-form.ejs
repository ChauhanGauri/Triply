<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || "Route Form" %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-dark: #1E293B;
      --primary-blue: #3B82F6;
      --accent-amber: #F59E0B;
      --accent-pink: #EC4899;
      --neutral-light: #F8FAFC;
      --neutral-gray: #F1F5F9;
    }

    body {
      background: linear-gradient(135deg, #F8FAFC 0%, #FFFFFF 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      margin: 0;
    }

    .dashboard-container {
      background: var(--neutral-light);
      min-height: 100vh;
    }

    .dashboard-header {
      background: var(--primary-dark);
      color: white;
      padding: 2rem 0;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.15);
    }

    .dashboard-title {
      background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .btn-custom {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-custom:hover {
      background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
      color: white;
      text-decoration: none;
    }

    .btn-outline-custom {
      background: transparent;
      border: 2px solid #F59E0B;
      color: #F59E0B;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-outline-custom:hover {
      background: #F59E0B;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
      text-decoration: none;
    }

    .section-card {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
      border: 1px solid #F1F5F9;
    }

    .form-card {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
      border: 1px solid #F1F5F9;
    }

    .form-title {
      color: #1E293B;
      font-weight: 600;
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
    }

    .form-control:focus {
      border-color: #F59E0B;
      box-shadow: 0 0 0 0.2rem rgba(245, 158, 11, 0.25);
    }

    .btn-secondary {
      background: #6B7280;
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #4B5563;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
    }

    @media (max-width: 768px) {
      .dashboard-container {
        border-radius: 0;
        margin: 0;
      }

      .dashboard-header {
        border-radius: 0;
        text-align: center;
      }

      .form-card {
        margin: 1rem;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>

  <div class="container-fluid p-0">
    <div class="row g-0 min-vh-100">
      <!-- Main Content -->
      <div class="col dashboard-container">

        <!-- Header -->
        <div class="dashboard-header">
          <div class="container">
            <div class="row align-items-center">
              <div class="col">
                <a href="/admin/dashboard" class="text-decoration-none">
                  <h1 class="dashboard-title mb-1">
                    <i class="bi bi-bus-front me-3"></i>
                    Triply
                  </h1>
                </a>
                <p class="mb-0 opacity-75">Admin Dashboard</p>
              </div>
              <div class="col-auto">
                <div class="d-flex gap-2 flex-wrap">
                  <a href="/admin/bookings" class="btn-custom">
                    <i class="bi bi-ticket-detailed"></i>
                    Bookings
                  </a>
                  <a href="/admin/routes" class="btn-custom">
                    <i class="bi bi-map"></i>
                    Routes
                  </a>
                  <a href="/admin/schedules" class="btn-custom">
                    <i class="bi bi-calendar-event"></i>
                    Schedules
                  </a>
                  <a href="/admin/users" class="btn-custom">
                    <i class="bi bi-people"></i>
                    Users
                  </a>
                  <a href="/auth/logout" class="btn-outline-custom">
                    <i class="bi bi-box-arrow-right"></i>
                    Logout
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="container py-4">
          <div class="row justify-content-center">
            <div class="col-lg-8">
              <div class="form-card">
                <h2 class="form-title">
                  <i class="bi bi-geo-alt me-2"></i>
                  <%= route ? 'Edit Route' : 'Add New Route' %>
                </h2>

                <form action="<%= route ? `/admin/routes/${route._id}?_method=PUT` : '/admin/routes' %>" method="POST">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="routeNumber" class="form-label">Route Number *</label>
                      <input type="text" class="form-control" id="routeNumber" name="routeNumber"
                             value="<%= route ? route.routeNumber : '' %>" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="fare" class="form-label">Fare (â‚¹) *</label>
                      <input type="number" class="form-control" id="fare" name="fare" step="0.01" min="0"
                             value="<%= route ? route.fare : '' %>" required>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="origin" class="form-label">Origin *</label>
                      <select class="form-control" id="origin" name="origin" required>
                        <option value="">Select Origin</option>
                      </select>
                      <small class="form-text text-muted">Select starting point</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="destination" class="form-label">Destination *</label>
                      <select class="form-control" id="destination" name="destination" required>
                        <option value="">Select Destination</option>
                      </select>
                      <small class="form-text text-muted">Valid destinations will be shown based on origin</small>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="distance" class="form-label">Distance (km) *</label>
                      <input type="number" class="form-control" id="distance" name="distance" step="0.1" min="0"
                             value="<%= route ? route.distance : '' %>" readonly required>
                      <small class="form-text text-muted">Auto-calculated based on origin and destination</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Duration *</label>
                      <div class="row g-2">
                        <div class="col-6">
                          <div class="input-group">
                            <input type="number" class="form-control" id="durationHours" min="0" max="23"
                                   value="<%= route ? Math.floor(route.duration / 60) : 0 %>" placeholder="0">
                            <span class="input-group-text">hrs</span>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="input-group">
                            <input type="number" class="form-control" id="durationMinutes" min="0" max="59"
                                   value="<%= route ? route.duration % 60 : 0 %>" placeholder="0">
                            <span class="input-group-text">mins</span>
                          </div>
                        </div>
                      </div>
                      <!-- Hidden field for actual duration in minutes -->
                      <input type="hidden" id="duration" name="duration" value="<%= route ? route.duration : '' %>" required>
                      <small class="form-text text-muted">You can adjust the auto-calculated duration</small>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="description" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Auto-generated description will appear here..."><%= route ? route.description || '' : '' %></textarea>
                    <small class="form-text text-muted">Auto-generated based on route. You can edit or clear this.</small>
                  </div>

                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="isActive" name="isActive"
                             <%= route ? (route.isActive ? 'checked' : '') : 'checked' %>>
                      <label class="form-check-label" for="isActive">
                        Active Route
                      </label>
                    </div>
                  </div>

                  <div class="d-flex justify-content-between">
                    <a href="/admin/routes" class="btn btn-secondary">
                      <i class="bi bi-arrow-left"></i> Back to Routes
                    </a>
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check-circle"></i>
                      <%= route ? 'Update Route' : 'Create Route' %>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Major Indian cities with their states and approximate distances
    const cities = [
      // North India
      { name: 'Delhi', state: 'Delhi', region: 'North' },
      { name: 'Chandigarh', state: 'Chandigarh', region: 'North' },
      { name: 'Amritsar', state: 'Punjab', region: 'North' },
      { name: 'Ludhiana', state: 'Punjab', region: 'North' },
      { name: 'Jalandhar', state: 'Punjab', region: 'North' },
      { name: 'Shimla', state: 'Himachal Pradesh', region: 'North' },
      { name: 'Manali', state: 'Himachal Pradesh', region: 'North' },
      { name: 'Dehradun', state: 'Uttarakhand', region: 'North' },
      { name: 'Haridwar', state: 'Uttarakhand', region: 'North' },
      { name: 'Jaipur', state: 'Rajasthan', region: 'North' },
      { name: 'Udaipur', state: 'Rajasthan', region: 'North' },
      { name: 'Jodhpur', state: 'Rajasthan', region: 'North' },
      { name: 'Agra', state: 'Uttar Pradesh', region: 'North' },
      { name: 'Lucknow', state: 'Uttar Pradesh', region: 'North' },
      { name: 'Varanasi', state: 'Uttar Pradesh', region: 'North' },
      { name: 'Kanpur', state: 'Uttar Pradesh', region: 'North' },
      
      // West India
      { name: 'Mumbai', state: 'Maharashtra', region: 'West' },
      { name: 'Pune', state: 'Maharashtra', region: 'West' },
      { name: 'Nagpur', state: 'Maharashtra', region: 'West' },
      { name: 'Ahmedabad', state: 'Gujarat', region: 'West' },
      { name: 'Surat', state: 'Gujarat', region: 'West' },
      { name: 'Vadodara', state: 'Gujarat', region: 'West' },
      { name: 'Goa', state: 'Goa', region: 'West' },
      
      // South India
      { name: 'Bangalore', state: 'Karnataka', region: 'South' },
      { name: 'Mysore', state: 'Karnataka', region: 'South' },
      { name: 'Mangalore', state: 'Karnataka', region: 'South' },
      { name: 'Chennai', state: 'Tamil Nadu', region: 'South' },
      { name: 'Coimbatore', state: 'Tamil Nadu', region: 'South' },
      { name: 'Madurai', state: 'Tamil Nadu', region: 'South' },
      { name: 'Hyderabad', state: 'Telangana', region: 'South' },
      { name: 'Vijayawada', state: 'Andhra Pradesh', region: 'South' },
      { name: 'Visakhapatnam', state: 'Andhra Pradesh', region: 'South' },
      { name: 'Kochi', state: 'Kerala', region: 'South' },
      { name: 'Thiruvananthapuram', state: 'Kerala', region: 'South' },
      { name: 'Kozhikode', state: 'Kerala', region: 'South' },
      
      // East India
      { name: 'Kolkata', state: 'West Bengal', region: 'East' },
      { name: 'Patna', state: 'Bihar', region: 'East' },
      { name: 'Ranchi', state: 'Jharkhand', region: 'East' },
      { name: 'Bhubaneswar', state: 'Odisha', region: 'East' },
      { name: 'Guwahati', state: 'Assam', region: 'East' }
    ];

    // Distance matrix (approximate distances in km between major cities)
    const distanceMatrix = {
      'Chandigarh': {
        'Delhi': 250, 'Amritsar': 230, 'Ludhiana': 110, 'Jalandhar': 145,
        'Shimla': 120, 'Manali': 310, 'Dehradun': 170, 'Haridwar': 210,
        'Jaipur': 520, 'Agra': 450
      },
      'Delhi': {
        'Chandigarh': 250, 'Amritsar': 450, 'Ludhiana': 340, 'Jalandhar': 380,
        'Shimla': 350, 'Manali': 540, 'Dehradun': 250, 'Haridwar': 220,
        'Jaipur': 280, 'Udaipur': 660, 'Jodhpur': 590, 'Agra': 210,
        'Lucknow': 550, 'Varanasi': 820, 'Kanpur': 460, 'Mumbai': 1420,
        'Ahmedabad': 940, 'Bangalore': 2150, 'Chennai': 2180, 'Hyderabad': 1570,
        'Kolkata': 1480, 'Guwahati': 1990
      },
      'Amritsar': {
        'Chandigarh': 230, 'Delhi': 450, 'Ludhiana': 140, 'Jalandhar': 85,
        'Shimla': 340, 'Manali': 460
      },
      'Ludhiana': {
        'Chandigarh': 110, 'Delhi': 340, 'Amritsar': 140, 'Jalandhar': 70,
        'Shimla': 230
      },
      'Jalandhar': {
        'Chandigarh': 145, 'Delhi': 380, 'Amritsar': 85, 'Ludhiana': 70,
        'Shimla': 270
      },
      'Shimla': {
        'Chandigarh': 120, 'Delhi': 350, 'Manali': 250, 'Dehradun': 240
      },
      'Manali': {
        'Chandigarh': 310, 'Delhi': 540, 'Shimla': 250
      },
      'Dehradun': {
        'Chandigarh': 170, 'Delhi': 250, 'Haridwar': 55, 'Shimla': 240
      },
      'Haridwar': {
        'Chandigarh': 210, 'Delhi': 220, 'Dehradun': 55
      },
      'Jaipur': {
        'Chandigarh': 520, 'Delhi': 280, 'Udaipur': 400, 'Jodhpur': 340,
        'Agra': 240, 'Ahmedabad': 680, 'Mumbai': 1140
      },
      'Udaipur': {
        'Delhi': 660, 'Jaipur': 400, 'Jodhpur': 260, 'Ahmedabad': 260,
        'Mumbai': 750
      },
      'Jodhpur': {
        'Delhi': 590, 'Jaipur': 340, 'Udaipur': 260, 'Ahmedabad': 480
      },
      'Agra': {
        'Chandigarh': 450, 'Delhi': 210, 'Jaipur': 240, 'Lucknow': 370,
        'Kanpur': 290
      },
      'Lucknow': {
        'Delhi': 550, 'Agra': 370, 'Varanasi': 320, 'Kanpur': 85
      },
      'Varanasi': {
        'Delhi': 820, 'Lucknow': 320, 'Kolkata': 680, 'Patna': 250
      },
      'Kanpur': {
        'Delhi': 460, 'Agra': 290, 'Lucknow': 85
      },
      'Mumbai': {
        'Delhi': 1420, 'Pune': 150, 'Nagpur': 820, 'Ahmedabad': 530,
        'Surat': 280, 'Vadodara': 430, 'Goa': 460, 'Bangalore': 980,
        'Hyderabad': 710, 'Chennai': 1340, 'Jaipur': 1140, 'Udaipur': 750
      },
      'Pune': {
        'Mumbai': 150, 'Nagpur': 720, 'Goa': 450, 'Bangalore': 840,
        'Hyderabad': 560, 'Ahmedabad': 670
      },
      'Nagpur': {
        'Mumbai': 820, 'Pune': 720, 'Hyderabad': 510, 'Bhopal': 350,
        'Kolkata': 1150
      },
      'Ahmedabad': {
        'Delhi': 940, 'Mumbai': 530, 'Pune': 670, 'Surat': 260,
        'Vadodara': 110, 'Udaipur': 260, 'Jaipur': 680
      },
      'Surat': {
        'Mumbai': 280, 'Ahmedabad': 260, 'Vadodara': 150
      },
      'Vadodara': {
        'Mumbai': 430, 'Ahmedabad': 110, 'Surat': 150
      },
      'Goa': {
        'Mumbai': 460, 'Pune': 450, 'Bangalore': 560, 'Mangalore': 350
      },
      'Bangalore': {
        'Delhi': 2150, 'Mumbai': 980, 'Pune': 840, 'Goa': 560,
        'Mysore': 145, 'Mangalore': 350, 'Chennai': 350, 'Coimbatore': 370,
        'Hyderabad': 570, 'Kochi': 560
      },
      'Mysore': {
        'Bangalore': 145, 'Mangalore': 270, 'Kochi': 480, 'Coimbatore': 280
      },
      'Mangalore': {
        'Bangalore': 350, 'Mysore': 270, 'Goa': 350, 'Kochi': 450
      },
      'Chennai': {
        'Delhi': 2180, 'Mumbai': 1340, 'Bangalore': 350, 'Coimbatore': 500,
        'Madurai': 460, 'Hyderabad': 630, 'Vijayawada': 430,
        'Visakhapatnam': 800, 'Kochi': 690, 'Kolkata': 1670
      },
      'Coimbatore': {
        'Bangalore': 370, 'Chennai': 500, 'Mysore': 280, 'Madurai': 220,
        'Kochi': 190
      },
      'Madurai': {
        'Chennai': 460, 'Coimbatore': 220, 'Thiruvananthapuram': 280,
        'Kochi': 270
      },
      'Hyderabad': {
        'Delhi': 1570, 'Mumbai': 710, 'Pune': 560, 'Nagpur': 510,
        'Bangalore': 570, 'Chennai': 630, 'Vijayawada': 270,
        'Visakhapatnam': 620
      },
      'Vijayawada': {
        'Hyderabad': 270, 'Chennai': 430, 'Visakhapatnam': 350
      },
      'Visakhapatnam': {
        'Hyderabad': 620, 'Vijayawada': 350, 'Chennai': 800,
        'Bhubaneswar': 440, 'Kolkata': 690
      },
      'Kochi': {
        'Bangalore': 560, 'Mysore': 480, 'Mangalore': 450, 'Chennai': 690,
        'Coimbatore': 190, 'Madurai': 270, 'Thiruvananthapuram': 210,
        'Kozhikode': 190
      },
      'Thiruvananthapuram': {
        'Kochi': 210, 'Madurai': 280, 'Kozhikode': 380
      },
      'Kozhikode': {
        'Kochi': 190, 'Thiruvananthapuram': 380, 'Mangalore': 230,
        'Bangalore': 400
      },
      'Kolkata': {
        'Delhi': 1480, 'Varanasi': 680, 'Patna': 580, 'Ranchi': 420,
        'Bhubaneswar': 450, 'Guwahati': 1010, 'Visakhapatnam': 690,
        'Chennai': 1670, 'Nagpur': 1150
      },
      'Patna': {
        'Delhi': 1000, 'Varanasi': 250, 'Kolkata': 580, 'Ranchi': 330
      },
      'Ranchi': {
        'Kolkata': 420, 'Patna': 330, 'Bhubaneswar': 510
      },
      'Bhubaneswar': {
        'Kolkata': 450, 'Ranchi': 510, 'Visakhapatnam': 440
      },
      'Guwahati': {
        'Delhi': 1990, 'Kolkata': 1010
      }
    };

    // Maximum practical bus travel distances (in km) from each city
    const maxPracticalDistance = 1500; // Maximum distance a bus would typically travel

    // Function to get distance between two cities
    function getDistance(origin, destination) {
      if (origin === destination) return 0;
      
      // Check direct route
      if (distanceMatrix[origin] && distanceMatrix[origin][destination]) {
        return distanceMatrix[origin][destination];
      }
      
      // Check reverse route
      if (distanceMatrix[destination] && distanceMatrix[destination][origin]) {
        return distanceMatrix[destination][origin];
      }
      
      return null;
    }

    // Function to calculate duration based on distance (avg speed 50 km/hr)
    function calculateDuration(distance) {
      const avgSpeed = 50; // km/hr
      const hours = distance / avgSpeed;
      return Math.round(hours * 60); // Convert to minutes
    }

    // Function to generate description based on route details
    function generateDescription(origin, destination, distance) {
      if (!origin || !destination || !distance) return '';
      
      const originCity = cities.find(c => c.name === origin);
      const destCity = cities.find(c => c.name === destination);
      
      if (!originCity || !destCity) return '';
      
      const hours = Math.floor(distance / 50);
      const minutes = Math.round((distance / 50 - hours) * 60);
      const timeStr = hours > 0 ? `${hours} hour${hours > 1 ? 's' : ''}${minutes > 0 ? ` ${minutes} min` : ''}` : `${minutes} minutes`;
      
      // Different templates based on route characteristics
      let description = '';
      
      if (distance < 150) {
        // Short distance routes
        description = `Direct express route connecting ${origin} (${originCity.state}) to ${destination} (${destCity.state}). ` +
                     `Comfortable ${distance}km journey in approximately ${timeStr}. ` +
                     `Perfect for daily commuters and quick city-to-city travel.`;
      } else if (distance < 500) {
        // Medium distance routes
        description = `Premium intercity bus service from ${origin} to ${destination}, covering ${distance}km. ` +
                     `Travel time approximately ${timeStr}. ` +
                     `Connecting ${originCity.state} and ${destCity.state} with comfortable seating and regular stops.`;
      } else if (distance < 1000) {
        // Long distance routes
        description = `Long-distance express service connecting ${origin} (${originCity.state}) to ${destination} (${destCity.state}). ` +
                     `${distance}km journey with an estimated travel time of ${timeStr}. ` +
                     `Equipped with modern amenities for a comfortable long-haul journey.`;
      } else {
        // Very long distance routes
        description = `Premium long-haul service from ${origin} to ${destination}, spanning ${distance}km across ${originCity.state} and ${destCity.state}. ` +
                     `Journey duration approximately ${timeStr}. ` +
                     `Luxury coaches with sleeper berths, rest stops, and onboard facilities for maximum comfort.`;
      }
      
      // Add regional context
      if (originCity.region !== destCity.region) {
        description += ` This inter-regional route connects ${originCity.region} India with ${destCity.region} India.`;
      }
      
      return description;
    }

    // Function to get valid destinations based on origin
    function getValidDestinations(origin) {
      if (!origin) return [];
      
      const validDestinations = [];
      
      cities.forEach(city => {
        if (city.name !== origin) {
          const distance = getDistance(origin, city.name);
          if (distance !== null && distance <= maxPracticalDistance) {
            validDestinations.push({
              ...city,
              distance: distance
            });
          }
        }
      });
      
      // Sort by distance
      return validDestinations.sort((a, b) => a.distance - b.distance);
    }

    // Populate origin dropdown
    function populateOrigin() {
      const originSelect = document.getElementById('origin');
      const currentOrigin = '<%= route ? route.origin : "" %>';
      
      // Group cities by region
      const regions = {};
      cities.forEach(city => {
        if (!regions[city.region]) {
          regions[city.region] = [];
        }
        regions[city.region].push(city);
      });
      
      // Add cities grouped by region
      Object.keys(regions).sort().forEach(region => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = region + ' India';
        
        regions[region].sort((a, b) => a.name.localeCompare(b.name)).forEach(city => {
          const option = document.createElement('option');
          option.value = city.name;
          option.textContent = `${city.name}, ${city.state}`;
          if (currentOrigin === city.name) {
            option.selected = true;
          }
          optgroup.appendChild(option);
        });
        
        originSelect.appendChild(optgroup);
      });
    }

    // Populate destination dropdown based on origin
    function populateDestination(origin) {
      const destinationSelect = document.getElementById('destination');
      const currentDestination = '<%= route ? route.destination : "" %>';
      
      // Clear existing options except the first one
      destinationSelect.innerHTML = '<option value="">Select Destination</option>';
      
      if (!origin) return;
      
      const validDestinations = getValidDestinations(origin);
      
      if (validDestinations.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No valid destinations found';
        option.disabled = true;
        destinationSelect.appendChild(option);
        return;
      }
      
      // Group by region
      const regions = {};
      validDestinations.forEach(city => {
        if (!regions[city.region]) {
          regions[city.region] = [];
        }
        regions[city.region].push(city);
      });
      
      Object.keys(regions).sort().forEach(region => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = region + ' India';
        
        regions[region].forEach(city => {
          const option = document.createElement('option');
          option.value = city.name;
          option.textContent = `${city.name}, ${city.state} (${city.distance} km)`;
          option.dataset.distance = city.distance;
          if (currentDestination === city.name) {
            option.selected = true;
          }
          optgroup.appendChild(option);
        });
        
        destinationSelect.appendChild(optgroup);
      });
    }

    // Update distance and duration when destination changes
    function updateDistanceAndDuration() {
      const origin = document.getElementById('origin').value;
      const destinationSelect = document.getElementById('destination');
      const destination = destinationSelect.value;
      const distanceInput = document.getElementById('distance');
      const durationInput = document.getElementById('duration');
      
      if (origin && destination) {
        const selectedOption = destinationSelect.options[destinationSelect.selectedIndex];
        const distance = parseFloat(selectedOption.dataset.distance);
        
        if (distance) {
          distanceInput.value = distance;
          const duration = calculateDuration(distance);
          durationInput.value = duration;
          
          // Update hours and minutes fields
          const hours = Math.floor(duration / 60);
          const minutes = duration % 60;
          document.getElementById('durationHours').value = hours;
          document.getElementById('durationMinutes').value = minutes;
        }
      } else {
        distanceInput.value = '';
        durationInput.value = '';
        document.getElementById('durationHours').value = 0;
        document.getElementById('durationMinutes').value = 0;
      }
    }

    // Duration calculation from hours and minutes
    const hoursInput = document.getElementById('durationHours');
    const minutesInput = document.getElementById('durationMinutes');
    const durationInput = document.getElementById('duration');

    function updateDuration() {
      const hours = parseInt(hoursInput.value) || 0;
      const minutes = parseInt(minutesInput.value) || 0;
      const totalMinutes = (hours * 60) + minutes;
      durationInput.value = totalMinutes;
      
      // Validation: Duration must be at least 1 minute
      if (totalMinutes < 1) {
        durationInput.setCustomValidity('Duration must be at least 1 minute');
      } else {
        durationInput.setCustomValidity('');
      }
    }

    // Update on input change
    if (hoursInput && minutesInput) {
      hoursInput.addEventListener('input', updateDuration);
      minutesInput.addEventListener('input', updateDuration);

      // Validate minutes don't exceed 59
      minutesInput.addEventListener('change', function() {
        if (this.value > 59) {
          this.value = 59;
          updateDuration();
        }
      });

      // Initialize on page load
      updateDuration();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      populateOrigin();
      
      const originSelect = document.getElementById('origin');
      const destinationSelect = document.getElementById('destination');
      
      // If editing existing route, populate destination
      if (originSelect.value) {
        populateDestination(originSelect.value);
        updateDistanceAndDuration();
      }
      
      // Event listeners
      originSelect.addEventListener('change', function() {
        populateDestination(this.value);
        updateDistanceAndDuration();
      });
      
      destinationSelect.addEventListener('change', updateDistanceAndDuration);

      // Validate form before submission
      const form = document.querySelector('form');
      form.addEventListener('submit', function(e) {
        const totalMinutes = parseInt(durationInput.value);
        if (totalMinutes < 1) {
          e.preventDefault();
          alert('Please enter a valid duration (at least 1 minute)');
          hoursInput.focus();
          return false;
        }
      });
    });
  </script>
</body>
</html>