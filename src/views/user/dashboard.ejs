<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || "My Bookings Dashboard" %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/modern-theme.css">
  <style>
    /* Global overflow prevention */
    html, body {
      overflow-x: hidden !important;
      width: 100%;
    }

    .container-fluid {
      overflow-x: hidden;
      width: 100%;
    }
    body {
      background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1E293B;
    }

    .dashboard-container {
      background: rgba(255, 255, 255, 0.95);
      min-height: 100vh;
      border-radius: 20px 0 0 20px;
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.8s ease-out;
    }

    .user-header {
      background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
      color: white;
      padding: 2rem 0;
      border-radius: 20px 0 0 0;
      position: relative;
      overflow: hidden;
    }

    .user-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -30px) rotate(120deg); }
      66% { transform: translate(-30px, 30px) rotate(240deg); }
    }

    .user-title {
      background: linear-gradient(135deg, #FFFFFF 0%, #CBD5E1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
    }

    .btn-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
      z-index: 1;
    }

    .btn-custom:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46a0 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      color: white;
      text-decoration: none;
    }

    .btn-outline-custom {
      background: transparent;
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 10px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
      z-index: 1;
    }

    .btn-outline-custom:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      text-decoration: none;
    }

    .stat-card {
      background: #FFFFFF;
      border: 2px solid #F1F5F9;
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
      position: relative;
      overflow: visible;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(30, 41, 59, 0.12);
      border-color: #667eea;
    }

    .stat-card:hover::before {
      width: 6px;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .stat-value {
      font-size: 2.25rem;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 0.125rem;
    }

    .stat-label {
      color: #64748B;
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-card {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
      border: 1px solid #F1F5F9;
    }

    .section-title {
      color: #1E293B;
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 1.2rem;
    }

    .table {
      background: #FFFFFF;
      border-radius: 12px;
      overflow: visible;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
    }

    .table thead th {
      background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
      border-bottom: 2px solid #E2E8F0;
      color: #1E293B;
      font-weight: 600;
      padding: 1rem 0.75rem;
    }

    .table tbody td {
      padding: 0.75rem;
      border-bottom: 1px solid #F1F5F9;
      color: #475569;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(102, 126, 234, 0.05);
    }

    /* Table column widths for responsive layout */
    .table th:nth-child(1), .table td:nth-child(1) { width: 12%; } /* Booking ID */
    .table th:nth-child(2), .table td:nth-child(2) { width: 30%; } /* Route */
    .table th:nth-child(3), .table td:nth-child(3) { width: 12%; } /* Seats */
    .table th:nth-child(4), .table td:nth-child(4) { width: 15%; } /* Status */
    .table th:nth-child(5), .table td:nth-child(5) { width: 15%; } /* Date */
    .table th:nth-child(6), .table td:nth-child(6) { width: 16%; } /* Actions */

    .table-container {
      overflow-x: hidden;
      width: 100%;
    }

    .table-container table {
      min-width: 100%;
      table-layout: fixed;
      width: 100%;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-confirmed {
      background: #D1FAE5;
      color: #065F46;
    }

    .status-pending {
      background: #FED7AA;
      color: #9A3412;
    }

    .status-cancelled {
      background: #FEE2E2;
      color: #991B1B;
    }

    .booking-card {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.08);
      border: 1px solid #F1F5F9;
    }

    .booking-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(30, 41, 59, 0.15);
    }

    .status-badge {
      font-size: 0.8em;
      padding: 0.4em 0.8em;
      border-radius: 20px;
      font-weight: 600;
    }

    .route-info {
      background: linear-gradient(135deg, #F8FAFC 0%, #FFFFFF 100%);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid #E2E8F0;
    }

    .upcoming-badge {
      background: linear-gradient(45deg, #10B981, #EC4899);
      color: white;
      border: none;
      border-radius: 20px;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    .btn btn-sm mt-2{
      background-color: #764ba2;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Header -->
  <div class="user-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col">
          <a href="/user/<%= data.user.id %>/dashboard" class="text-decoration-none">
            <h1 class="user-title mb-1">
              <i class="bi bi-bus-front me-3"></i>
              Triply
            </h1>
          </a>
          <p class="mb-0 opacity-75"><%= data.user.name %></p>
        </div>
        <div class="col-auto">
          <a href="/user/<%= data.user.id %>/bookings/new" class="btn-custom me-2">
            <i class="bi bi-plus-circle"></i> New Booking
          </a>
          <a href="/auth/logout" class="btn-outline-custom">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid p-0">
    <div class="row g-0 min-vh-100">
      <div class="col dashboard-container">
        <div class="container mt-4">

          <!-- Statistics Overview -->
          <div class="section-card">
            <h2 class="section-title">
              <i class="bi bi-bar-chart-line me-2"></i>
              Booking Overview
            </h2>
            <div class="row">
              <div class="col-md-3 mb-3">
                <div class="stat-card h-100">
                  <div class="stat-icon"><i class="bi bi-ticket-detailed"></i></div>
                  <div class="stat-value"><%= data.stats.totalBookings %></div>
                  <div class="stat-label">Total Bookings</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card h-100">
                  <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                  <div class="stat-value"><%= data.stats.confirmedBookings %></div>
                  <div class="stat-label">Confirmed</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card h-100">
                  <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                  <div class="stat-value"><%= data.stats.upcomingBookings %></div>
                  <div class="stat-label">Upcoming</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card h-100">
                  <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                  <div class="stat-value"><%= data.stats.cancelledBookings %></div>
                  <div class="stat-label">Cancelled</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Upcoming Bookings -->
          <% if (data.upcomingBookings && data.upcomingBookings.length > 0) { %>
            <div class="section-card">
              <h2 class="section-title"><i class="bi bi-calendar-event me-2"></i>Upcoming Trips</h2>
              <div class="row">
                <% data.upcomingBookings.forEach(booking => { %>
                  <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card booking-card h-100">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                          <h6 class="card-title mb-0">
                            <% if (booking.schedule && booking.schedule.route) { %>
                              <%= booking.schedule.route.routeNumber %>
                            <% } else { %>
                              Route Information Unavailable
                            <% } %>
                          </h6>
                          <span class="badge upcoming-badge">Upcoming</span>
                        </div>
                        <% if (booking.schedule && booking.schedule.route) { %>
                          <div class="route-info mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="fw-bold"><%= booking.schedule.route.origin || 'N/A' %></span>
                              <i class="bi bi-arrow-right text-muted"></i>
                              <span class="fw-bold"><%= booking.schedule.route.destination || 'N/A' %></span>
                            </div>
                          </div>
                        <% } else { %>
                          <div class="route-info mb-3 text-muted text-center"><i class="bi bi-exclamation-triangle"></i> Route details not available</div>
                        <% } %>
                        <div class="d-flex justify-content-between align-items-center">
                          <small class="text-muted"><i class="bi bi-person-fill"></i> <%= booking.seats %> seat(s)</small>
                          <small class="text-muted"><i class="bi bi-calendar"></i> <%= new Date(booking.createdAt).toLocaleDateString() %></small>
                        </div>
                        <div class="mt-3">
                          <button class="btn btn-outline-danger btn-sm" onclick="cancelBooking('<%= booking._id %>')"><i class="bi bi-x-circle"></i> Cancel Trip</button>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          <% } %>

          <!-- All Bookings + Quick Actions Row -->
          <div class="row">
            <div class="col-lg-8 mb-4">
              <div class="section-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h2 class="section-title mb-0"><i class="bi bi-list-ul me-2"></i>My Bookings</h2>
                  <div class="btn-group">
                    <button class="btn btn-outline-secondary active" onclick="filterBookings('all')">All</button>
                    <button class="btn btn-outline-secondary" onclick="filterBookings('confirmed')">Confirmed</button>
                    <button class="btn btn-outline-secondary" onclick="filterBookings('cancelled')">Cancelled</button>
                  </div>
                </div>
                <div class="table-container">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Booking ID</th>
                        <th>Route</th>
                        <th>Seats</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="bookingsTable">
                      <% if (data.bookings && data.bookings.length > 0) { %>
                        <% data.bookings.forEach(booking => { %>
                          <tr data-status="<%= booking.status %>" data-booking-id="<%= booking._id %>">
                            <td><code>#<%= booking._id.toString().slice(-6) %></code></td>
                            <td>
                              <% if (booking.schedule && booking.schedule.route) { %>
                                <strong><%= booking.schedule.route.routeNumber %></strong>
                                <br><small class="text-muted"><%= booking.schedule.route.origin %> → <%= booking.schedule.route.destination %></small>
                              <% } else { %>
                                <span class="text-muted">Route not found</span>
                              <% } %>
                            </td>
                            <td><span class="status-badge status-pending"><%= booking.seats %> seat(s)</span></td>
                            <td>
                              <% if (booking.status === 'confirmed') { %>
                                <span class="status-badge status-confirmed">Confirmed</span>
                              <% } else if (booking.status === 'cancelled') { %>
                                <span class="status-badge status-cancelled">Cancelled</span>
                              <% } else { %>
                                <span class="status-badge status-pending"><%= booking.status %></span>
                              <% } %>
                            </td>
                            <td><small><%= new Date(booking.createdAt).toLocaleDateString() %></small></td>
                            <td>
                              <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" title="View Details" onclick="viewBookingDetails('<%= booking._id %>')"><i class="bi bi-eye"></i></button>
                                <% if (booking.status === 'confirmed') { %>
                                  <button class="btn btn-outline-danger btn-sm" title="Cancel Booking" onclick="cancelBooking('<%= booking._id %>')"><i class="bi bi-x-circle"></i></button>
                                <% } %>
                              </div>
                            </td>
                          </tr>
                        <% }); %>
                      <% } else { %>
                        <tr>
                          <td colspan="6" class="text-center py-4 text-muted">
                            <i class="bi bi-inbox"></i> No bookings found
                            
                          </td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-lg-4 mb-4">
              <div class="section-card">
                <h3 class="section-title"><i class="bi bi-lightning me-2"></i>Quick Actions</h3>
                <div class="d-grid gap-3">
                  <a href="/user/<%= data.user.id %>/bookings/new" class="btn-custom"><i class="bi bi-plus-circle"></i> New Booking</a>
                  <a href="/user/schedule" class="btn-custom"><i class="bi bi-calendar-week"></i> View Schedules</a>
                  <a href="/user/routes" class="btn-custom"><i class="bi bi-map"></i> Browse Routes</a>
                  <a href="/user/profile" class="btn-custom"><i class="bi bi-person-gear"></i> Edit Profile</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Recently Viewed + Available Routes Row -->
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="section-card">
                <div class="d-flex align-items-center justify-content-between">
                  <h3 class="section-title mb-0">
                    <i class="bi bi-clock-history me-2"></i>Recently Viewed Routes
                  </h3>
                  <button class="btn btn-sm btn-outline-secondary" id="clearRecentBtn" style="display:none;">
                    <i class="bi bi-trash"></i> Clear
                  </button>
                </div>
                <div id="recentlyViewedRoutes" class="mt-3">
                  <p class="text-muted text-center mb-0">No recently viewed routes yet.</p>
                </div>
              </div>
            </div>
            <div class="col-lg-6 mb-4">
              <div class="section-card">
                <h3 class="section-title"><i class="bi bi-map me-2"></i>Available Routes</h3>
                <div class="card-body">
                  <% if (data.availableRoutes && data.availableRoutes.length > 0) { %>
                    <% data.availableRoutes.slice(0, 5).forEach(route => { %>
                      <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                          <strong><%= route.routeNumber || 'N/A' %></strong>
                          <br><small class="text-muted"><%= route.origin || 'N/A' %> → <%= route.destination || 'N/A' %></small>
                          <% if (route.fare) { %><br><small class="text-success">Fare: ₹<%= route.fare %></small><% } %>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="bookRoute('<%= route._id %>')">Book</button>
                      </div>
                    <% }); %>
                    <% if (data.availableRoutes.length > 5) { %>
                      <div class="text-center mt-3"><a href="/user/routes" class="btn btn-sm btn-link">View All Routes</a></div>
                    <% } %>
                  <% } else { %>
                    <p class="text-muted text-center">No routes available</p>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

        </div> <!-- /.container mt-4 -->
      </div> <!-- /.col dashboard-container -->
    </div> <!-- /.row -->
  </div> <!-- /.container-fluid -->

  <!-- Cancel Booking Modal -->
  <div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cancel Booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to cancel this booking? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Booking</button>
          <button type="button" class="btn btn-danger" id="confirmCancel">Cancel Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="bookingDetailsContent">
          <!-- Booking details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let bookingToCancel = null;
    
    function filterBookings(status) {
      const rows = document.querySelectorAll('#bookingsTable tr[data-status]');
      const buttons = document.querySelectorAll('.btn-group button');
      
      // Update active button
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Filter rows
      rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    function cancelBooking(bookingId) {
      bookingToCancel = bookingId;
      new bootstrap.Modal(document.getElementById('cancelModal')).show();
    }
    
    function viewBookingDetails(bookingId) {
      // This would typically fetch booking details via API
      document.getElementById('bookingDetailsContent').innerHTML = `
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading booking details...</p>
        </div>
      `;
      new bootstrap.Modal(document.getElementById('detailsModal')).show();
      
      // Simulate API call
      setTimeout(() => {
        document.getElementById('bookingDetailsContent').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Booking Information</h6>
              <p><strong>Booking ID:</strong> #${bookingId.slice(-6)}</p>
              <p><strong>Status:</strong> <span class="badge bg-success">Confirmed</span></p>
              <p><strong>Booking Date:</strong> ${new Date().toLocaleDateString()}</p>
            </div>
            <div class="col-md-6">
              <h6>Trip Details</h6>
              <p><strong>Route:</strong> City Express</p>
              <p><strong>From:</strong> Downtown → Airport</p>
              <p><strong>Seats:</strong> 2</p>
            </div>
          </div>
        `;
      }, 1000);
    }
    
    function bookRoute(routeId) {
      // Redirect to route selection page with specific route filter
      window.location.href = `/user/<%= data.user.id %>/bookings/select-route?routeId=${routeId}`;
    }
    
    document.getElementById('confirmCancel').addEventListener('click', async function() {
      if (bookingToCancel) {
        try {
          const response = await fetch(`/api/bookings/${bookingToCancel}/cancel`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            location.reload(); // Refresh the page to show updated data
          } else {
            alert('Failed to cancel booking. Please try again.');
          }
        } catch (error) {
          alert('Error cancelling booking. Please try again.');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
      }
    });
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/localStorage.js"></script>
  <script>
    try {
      const socket = io();
      socket.emit('joinRoom', `user_<%= data.user.id %>`);

      socket.on('bookingCancelled', (payload) => {
        try {
          const booking = payload.booking;

          // Update bookings table rows
          const row = document.querySelector(`#bookingsTable tr[data-booking-id="${booking._id}"]`);
          if (row) {
            row.dataset.status = 'cancelled';
            const statusCell = row.querySelectorAll('td')[3];
            if (statusCell) statusCell.innerHTML = '<span class="status-badge status-cancelled">Cancelled</span>';
          }

          // Update upcoming bookings cards if present
          const cards = document.querySelectorAll('.booking-card');
          cards.forEach(card => {
            if (card.innerHTML.includes(booking._id)) {
              // replace Cancel button with Cancelled badge
              const btn = card.querySelector('button.btn-outline-danger');
              if (btn) {
                btn.replaceWith((() => {
                  const span = document.createElement('span');
                  span.className = 'badge bg-danger';
                  span.textContent = 'Cancelled';
                  return span;
                })());
              }
              // also update any 'Upcoming' badge
              const upcoming = card.querySelector('.upcoming-badge');
              if (upcoming) upcoming.remove();
            }
          });

          // Notify user
          alert('A booking was cancelled by admin. Your UI has been updated.');
        } catch (err) {
          console.error('Error handling bookingCancelled on dashboard:', err);
        }
      });
    } catch (err) {
      console.warn('Socket client failed on user dashboard:', err.message);
    }
  </script>
  <script>
    function renderRecentlyViewedRoutes() {
      if (typeof LocalStorageManager === 'undefined') {
        console.warn('LocalStorageManager not found.');
        return;
      }

      const container = document.getElementById('recentlyViewedRoutes');
      const clearBtn = document.getElementById('clearRecentBtn');

      if (!container) return;

      const recentRoutes = LocalStorageManager.getRecentlyViewedRoutes(5);

      if (!recentRoutes || recentRoutes.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0">No recently viewed routes yet.</p>';
        if (clearBtn) clearBtn.style.display = 'none';
        return;
      }

      if (clearBtn) {
        clearBtn.style.display = 'inline-flex';
        clearBtn.onclick = () => {
          if (confirm('Clear recently viewed routes?')) {
            LocalStorageManager.clearRecentlyViewedRoutes();
            renderRecentlyViewedRoutes();
          }
        };
      }

      container.innerHTML = '';
      recentRoutes.forEach(route => {
        const card = document.createElement('div');
        card.className = 'border rounded p-3 mb-2';
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${route.routeNumber || 'Route'}</strong>
              <br><small class="text-muted">${route.origin || 'Origin'} → ${route.destination || 'Destination'}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${route.fare ? '₹' + route.fare : ''}</div>
              <small class="text-muted">${route.viewedAt ? new Date(route.viewedAt).toLocaleString() : ''}</small>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderRecentlyViewedRoutes();
    });
  </script>
  </div>
</body>
</html>