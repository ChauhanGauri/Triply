<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || "My Bookings Dashboard" %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .stat-card {
      border-left: 4px solid #007bff;
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    .stat-card.confirmed {
      border-left-color: #28a745;
    }
    .stat-card.cancelled {
      border-left-color: #dc3545;
    }
    .stat-card.upcoming {
      border-left-color: #17a2b8;
    }
    .user-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    .booking-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .booking-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .status-badge {
      font-size: 0.8em;
      padding: 0.4em 0.8em;
    }
    .route-info {
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .upcoming-badge {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border: none;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Header -->
  <div class="user-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col">
          <h1 class="mb-1"><i class="bi bi-person-circle"></i> Welcome, <%= data.user.name %>!</h1>
          <p class="mb-0">Manage your transportation bookings</p>
        </div>
        <div class="col-auto">
          <a href="/user/<%= data.user.id %>/bookings/new" class="btn btn-light me-2">
            <i class="bi bi-plus-circle"></i> New Booking
          </a>
          <a href="/api/bookings/user/<%= data.user.id || 'me' %>" class="btn btn-outline-light">
            <i class="bi bi-download"></i> Export
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-subtitle mb-2 text-muted">Total Bookings</h6>
                <h2 class="card-title mb-0"><%= data.stats.totalBookings %></h2>
              </div>
              <div class="align-self-center">
                <i class="bi bi-ticket-detailed text-primary" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card stat-card confirmed h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-subtitle mb-2 text-muted">Confirmed</h6>
                <h2 class="card-title mb-0 text-success"><%= data.stats.confirmedBookings %></h2>
              </div>
              <div class="align-self-center">
                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card stat-card upcoming h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-subtitle mb-2 text-muted">Upcoming</h6>
                <h2 class="card-title mb-0 text-info"><%= data.stats.upcomingBookings %></h2>
              </div>
              <div class="align-self-center">
                <i class="bi bi-calendar-check text-info" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card stat-card cancelled h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-subtitle mb-2 text-muted">Cancelled</h6>
                <h2 class="card-title mb-0 text-danger"><%= data.stats.cancelledBookings %></h2>
              </div>
              <div class="align-self-center">
                <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Bookings -->
    <% if (data.upcomingBookings && data.upcomingBookings.length > 0) { %>
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Upcoming Trips</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <% data.upcomingBookings.forEach(booking => { %>
                  <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card booking-card h-100">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                          <h6 class="card-title mb-0">
                            <% if (booking.schedule && booking.schedule.route) { %>
                              <%= booking.schedule.route.routeNumber %>
                            <% } else { %>
                              Route Information Unavailable
                            <% } %>
                          </h6>
                          <span class="badge upcoming-badge">Upcoming</span>
                        </div>
                        <% if (booking.schedule && booking.schedule.route) { %>
                          <div class="route-info mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="fw-bold"><%= booking.schedule.route.origin || 'N/A' %></span>
                              <i class="bi bi-arrow-right text-muted"></i>
                              <span class="fw-bold"><%= booking.schedule.route.destination || 'N/A' %></span>
                            </div>
                          </div>
                        <% } else { %>
                          <div class="route-info mb-3">
                            <div class="text-muted text-center">
                              <i class="bi bi-exclamation-triangle"></i> Route details not available
                            </div>
                          </div>
                        <% } %>
                        <div class="d-flex justify-content-between align-items-center">
                          <small class="text-muted">
                            <i class="bi bi-person-fill"></i> <%= booking.seats %> seat(s)
                          </small>
                          <small class="text-muted">
                            <i class="bi bi-calendar"></i> <%= new Date(booking.createdAt).toLocaleDateString() %>
                          </small>
                        </div>
                        <div class="mt-3">
                          <button class="btn btn-outline-danger btn-sm" onclick="cancelBooking('<%= booking._id %>')">
                            <i class="bi bi-x-circle"></i> Cancel Trip
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <!-- All Bookings -->
    <div class="row">
      <div class="col-lg-8 mb-4">
        <div class="card">
          <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-list-ul"></i> My Bookings</h5>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary active" onclick="filterBookings('all')">All</button>
                <button class="btn btn-outline-secondary" onclick="filterBookings('confirmed')">Confirmed</button>
                <button class="btn btn-outline-secondary" onclick="filterBookings('cancelled')">Cancelled</button>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Booking ID</th>
                    <th>Route</th>
                    <th>Seats</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bookingsTable">
                  <% if (data.bookings && data.bookings.length > 0) { %>
                    <% data.bookings.forEach(booking => { %>
                      <tr data-status="<%= booking.status %>">
                        <td><code>#<%= booking._id.toString().slice(-6) %></code></td>
                        <td>
                          <% if (booking.schedule && booking.schedule.route) { %>
                            <strong><%= booking.schedule.route.routeNumber %></strong>
                            <br><small class="text-muted"><%= booking.schedule.route.origin %> → <%= booking.schedule.route.destination %></small>
                          <% } else { %>
                            <span class="text-muted">Route not found</span>
                          <% } %>
                        </td>
                        <td><span class="badge bg-info"><%= booking.seats %> seat(s)</span></td>
                        <td>
                          <% if (booking.status === 'confirmed') { %>
                            <span class="badge bg-success status-badge">Confirmed</span>
                          <% } else if (booking.status === 'cancelled') { %>
                            <span class="badge bg-danger status-badge">Cancelled</span>
                          <% } else { %>
                            <span class="badge bg-secondary status-badge"><%= booking.status %></span>
                          <% } %>
                        </td>
                        <td><small><%= new Date(booking.createdAt).toLocaleDateString() %></small></td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" title="View Details" 
                                    onclick="viewBookingDetails('<%= booking._id %>')">
                              <i class="bi bi-eye"></i>
                            </button>
                            <% if (booking.status === 'confirmed') { %>
                              <button class="btn btn-outline-danger btn-sm" title="Cancel Booking" 
                                      onclick="cancelBooking('<%= booking._id %>')">
                                <i class="bi bi-x-circle"></i>
                              </button>
                            <% } %>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="6" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox"></i> No bookings found
                        <br><a href="/user/<%= data.user.id %>/bookings/new" class="btn btn-primary btn-sm mt-2">Make Your First Booking</a>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions & New Booking -->
      <div class="col-lg-4 mb-4">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-3">
              <a href="/user/<%= data.user.id %>/bookings/new" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> New Booking
              </a>
              <a href="/user/schedule" class="btn btn-success">
                <i class="bi bi-calendar-week"></i> View Schedules
              </a>
              <a href="/user/routes" class="btn btn-info">
                <i class="bi bi-map"></i> Browse Routes
              </a>
              <a href="/user/profile" class="btn btn-secondary">
                <i class="bi bi-person-gear"></i> Edit Profile
              </a>
            </div>
          </div>
        </div>

        <!-- Available Routes -->
        <div class="card mt-4">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-map"></i> Available Routes</h5>
          </div>
          <div class="card-body">
            <% if (data.availableRoutes && data.availableRoutes.length > 0) { %>
              <% data.availableRoutes.slice(0, 5).forEach(route => { %>
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                  <div>
                    <strong><%= route.routeNumber || 'N/A' %></strong>
                    <br><small class="text-muted"><%= route.origin || 'N/A' %> → <%= route.destination || 'N/A' %></small>
                    <% if (route.fare) { %>
                      <br><small class="text-success">Fare: ₹<%= route.fare %></small>
                    <% } %>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" onclick="bookRoute('<%= route._id %>')">
                    Book
                  </button>
                </div>
              <% }); %>
              <% if (data.availableRoutes.length > 5) { %>
                <div class="text-center mt-3">
                  <a href="/user/routes" class="btn btn-sm btn-link">View All Routes</a>
                </div>
              <% } %>
            <% } else { %>
              <p class="text-muted text-center">No routes available</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Booking Modal -->
  <div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cancel Booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to cancel this booking? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Booking</button>
          <button type="button" class="btn btn-danger" id="confirmCancel">Cancel Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="bookingDetailsContent">
          <!-- Booking details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let bookingToCancel = null;
    
    function filterBookings(status) {
      const rows = document.querySelectorAll('#bookingsTable tr[data-status]');
      const buttons = document.querySelectorAll('.btn-group button');
      
      // Update active button
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Filter rows
      rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    function cancelBooking(bookingId) {
      bookingToCancel = bookingId;
      new bootstrap.Modal(document.getElementById('cancelModal')).show();
    }
    
    function viewBookingDetails(bookingId) {
      // This would typically fetch booking details via API
      document.getElementById('bookingDetailsContent').innerHTML = `
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading booking details...</p>
        </div>
      `;
      new bootstrap.Modal(document.getElementById('detailsModal')).show();
      
      // Simulate API call
      setTimeout(() => {
        document.getElementById('bookingDetailsContent').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Booking Information</h6>
              <p><strong>Booking ID:</strong> #${bookingId.slice(-6)}</p>
              <p><strong>Status:</strong> <span class="badge bg-success">Confirmed</span></p>
              <p><strong>Booking Date:</strong> ${new Date().toLocaleDateString()}</p>
            </div>
            <div class="col-md-6">
              <h6>Trip Details</h6>
              <p><strong>Route:</strong> City Express</p>
              <p><strong>From:</strong> Downtown → Airport</p>
              <p><strong>Seats:</strong> 2</p>
            </div>
          </div>
        `;
      }, 1000);
    }
    
    function bookRoute(routeId) {
      // Redirect to route selection page with specific route filter
      window.location.href = `/user/<%= data.user.id %>/bookings/select-route?routeId=${routeId}`;
    }
    
    document.getElementById('confirmCancel').addEventListener('click', async function() {
      if (bookingToCancel) {
        try {
          const response = await fetch(`/api/bookings/${bookingToCancel}/cancel`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            location.reload(); // Refresh the page to show updated data
          } else {
            alert('Failed to cancel booking. Please try again.');
          }
        } catch (error) {
          alert('Error cancelling booking. Please try again.');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
      }
    });
  </script>
</body>
</html>