<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || "Select Route & Schedule" %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .route-card {
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .route-card:hover {
      border-color: #007bff;
      box-shadow: 0 4px 15px rgba(0,123,255,0.2);
    }
    .route-card.selected {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    .schedule-item {
      border-left: 3px solid #007bff;
      background-color: #f8f9fa;
    }
    .available-seats {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border-radius: 20px;
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .price-tag {
      background: linear-gradient(45deg, #fd7e14, #e83e8c);
      color: white;
      border-radius: 15px;
      padding: 0.5rem 1rem;
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Header -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/user/<%= user.id %>/dashboard">
        <i class="bi bi-bus-front"></i> Transport System
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/user/<%= user.id %>/dashboard">Dashboard</a>
        <a class="nav-link" href="/user/<%= user.id %>/bookings">My Bookings</a>
        <a class="nav-link" href="/auth/logout">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2><i class="bi bi-geo-alt"></i> 
          <%= selectedRouteId ? 'Select Schedule for Route' : 'Select Route & Schedule' %>
        </h2>
        <p class="text-muted">
          <%= selectedRouteId ? 'Choose your preferred travel schedule for this route' : 'Choose your preferred route and travel schedule' %>
        </p>
      </div>
      <div class="btn-group">
        <% if (selectedRouteId) { %>
          <a href="/user/<%= user.id %>/bookings/select-route" class="btn btn-outline-info">
            <i class="bi bi-list"></i> Show All Routes
          </a>
        <% } %>
        <a href="/user/<%= user.id %>/dashboard" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-funnel me-2"></i>Filter Buses
          <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#filterSection">
            <i class="bi bi-gear"></i> Show Filters
          </button>
        </h5>
      </div>
      <div class="collapse" id="filterSection">
        <div class="card-body">
          <form id="filterForm">
            <div class="row g-3">
              <!-- Date Filter -->
              <div class="col-md-3">
                <label for="journeyDate" class="form-label">
                  <i class="bi bi-calendar3"></i> Journey Date
                </label>
                <input type="date" class="form-control" id="journeyDate" name="journeyDate" 
                       min="<%= new Date().toISOString().split('T')[0] %>">
              </div>
              
              <!-- Departure Time Range -->
              <div class="col-md-3">
                <label for="departureTimeFrom" class="form-label">
                  <i class="bi bi-clock"></i> Departure From
                </label>
                <select class="form-select" id="departureTimeFrom" name="departureTimeFrom">
                  <option value="">Any Time</option>
                  <option value="06:00">6:00 AM</option>
                  <option value="08:00">8:00 AM</option>
                  <option value="10:00">10:00 AM</option>
                  <option value="12:00">12:00 PM</option>
                  <option value="14:00">2:00 PM</option>
                  <option value="16:00">4:00 PM</option>
                  <option value="18:00">6:00 PM</option>
                  <option value="20:00">8:00 PM</option>
                  <option value="22:00">10:00 PM</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label for="departureTimeTo" class="form-label">
                  <i class="bi bi-clock-fill"></i> Departure To
                </label>
                <select class="form-select" id="departureTimeTo" name="departureTimeTo">
                  <option value="">Any Time</option>
                  <option value="08:00">8:00 AM</option>
                  <option value="10:00">10:00 AM</option>
                  <option value="12:00">12:00 PM</option>
                  <option value="14:00">2:00 PM</option>
                  <option value="16:00">4:00 PM</option>
                  <option value="18:00">6:00 PM</option>
                  <option value="20:00">8:00 PM</option>
                  <option value="22:00">10:00 PM</option>
                  <option value="23:59">11:59 PM</option>
                </select>
              </div>
              
              <!-- Route Filter -->
              <div class="col-md-3">
                <label for="routeFilter" class="form-label">
                  <i class="bi bi-signpost"></i> Route
                </label>
                <select class="form-select" id="routeFilter" name="routeFilter">
                  <option value="">All Routes</option>
                  <!-- Routes will be populated dynamically -->
                </select>
              </div>
              
              <!-- Minimum Seats Filter -->
              <div class="col-md-3">
                <label for="minSeats" class="form-label">
                  <i class="bi bi-person-plus"></i> Min Available Seats
                </label>
                <select class="form-select" id="minSeats" name="minSeats">
                  <option value="1">At least 1 seat</option>
                  <option value="2">At least 2 seats</option>
                  <option value="4">At least 4 seats</option>
                  <option value="6">At least 6 seats</option>
                  <option value="10">At least 10 seats</option>
                </select>
              </div>
              
              <!-- Fare Range Filter -->
              <div class="col-md-3">
                <label for="maxFare" class="form-label">
                  <i class="bi bi-currency-rupee"></i> Max Fare
                </label>
                <select class="form-select" id="maxFare" name="maxFare">
                  <option value="">Any Price</option>
                  <option value="500">Under ₹500</option>
                  <option value="1000">Under ₹1000</option>
                  <option value="1500">Under ₹1500</option>
                  <option value="2000">Under ₹2000</option>
                </select>
              </div>
              
              <!-- Sort Options -->
              <div class="col-md-3">
                <label for="sortBy" class="form-label">
                  <i class="bi bi-sort-down"></i> Sort By
                </label>
                <select class="form-select" id="sortBy" name="sortBy">
                  <option value="departure">Departure Time</option>
                  <option value="fare">Fare (Low to High)</option>
                  <option value="seats">Available Seats</option>
                  <option value="journey">Journey Date</option>
                </select>
              </div>
              
              <!-- Filter Actions -->
              <div class="col-md-3 d-flex align-items-end">
                <div class="d-flex gap-2 w-100">
                  <button type="button" class="btn btn-primary flex-grow-1" onclick="applyFilters()">
                    <i class="bi bi-search"></i> Apply
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Clear
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <span id="resultsCount">
              <% if (schedules && schedules.length > 0) { %>
                <%= schedules.length %> bus<%= schedules.length !== 1 ? 'es' : '' %> available
              <% } else { %>
                No buses available
              <% } %>
            </span>
          </h5>
          <small class="text-muted" id="filterStatus">Showing all available buses</small>
        </div>
      </div>
    </div>

    <!-- Error/Success Messages -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <% if (schedules && schedules.length > 0) { %>
      <!-- Group schedules by route -->
      <%
        const routeGroups = {};
        schedules.forEach(schedule => {
          const routeKey = schedule.route._id;
          if (!routeGroups[routeKey]) {
            routeGroups[routeKey] = {
              route: schedule.route,
              schedules: []
            };
          }
          routeGroups[routeKey].schedules.push(schedule);
        });
      %>

      <div class="row">
        <% Object.values(routeGroups).forEach((group, index) => { %>
          <div class="col-12 mb-4">
            <div class="card route-card h-100" 
                 data-route-id="<%= group.route._id %>"
                 data-route-number="<%= group.route.routeNumber %>">
              <div class="card-header bg-white">
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <h5 class="mb-1">
                      <i class="bi bi-signpost-2"></i> 
                      Route <%= group.route.routeNumber %>
                    </h5>
                    <div class="d-flex align-items-center">
                      <span class="badge bg-primary me-2">
                        <i class="bi bi-geo-alt"></i> <%= group.route.origin %>
                      </span>
                      <i class="bi bi-arrow-right mx-2"></i>
                      <span class="badge bg-success">
                        <i class="bi bi-geo-alt-fill"></i> <%= group.route.destination %>
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4 text-md-end">
                    <div class="price-tag">
                      <i class="bi bi-currency-rupee"></i><%= group.route.fare %> per person
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="row">
                  <% group.schedules.forEach(schedule => { %>
                    <div class="col-lg-6 col-xl-4 mb-3">
                      <div class="schedule-item p-3 rounded h-100">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                          <div>
                            <h6 class="mb-1">
                              <i class="bi bi-calendar-date"></i>
                              <%= new Date(schedule.journeyDate).toLocaleDateString('en-US', { 
                                weekday: 'short', 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                              }) %>
                            </h6>
                            <div class="text-muted small">
                              <i class="bi bi-clock"></i>
                              <%= schedule.departureTime %> - <%= schedule.arrivalTime %>
                            </div>
                          </div>
                          <span class="available-seats">
                            <i class="bi bi-people"></i> <%= schedule.availableSeats %> seats
                          </span>
                        </div>
                        
                        <div class="row text-center mb-3">
                          <div class="col-6">
                            <small class="text-muted">Bus Number</small>
                            <div class="fw-bold"><%= schedule.busNumber %></div>
                          </div>
                          <div class="col-6">
                            <small class="text-muted">Driver</small>
                            <div class="fw-bold"><%= schedule.driverName %></div>
                          </div>
                        </div>

                        <div class="d-grid">
                          <button type="button" 
                                  class="btn btn-primary select-schedule" 
                                  data-schedule-id="<%= schedule._id %>"
                                  data-route-number="<%= group.route.routeNumber %>"
                                  data-origin="<%= group.route.origin %>"
                                  data-destination="<%= group.route.destination %>"
                                  data-fare="<%= group.route.fare %>"
                                  data-date="<%= new Date(schedule.journeyDate).toLocaleDateString() %>"
                                  data-departure="<%= schedule.departureTime %>"
                                  data-arrival="<%= schedule.arrivalTime %>"
                                  data-available-seats="<%= schedule.availableSeats %>"
                                  data-bus-number="<%= schedule.busNumber %>"
                                  data-driver="<%= schedule.driverName %>">
                            <i class="bi bi-ticket-perforated"></i> Select This Schedule
                          </button>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="text-center py-5">
        <i class="bi bi-calendar-x display-1 text-muted"></i>
        <h3 class="mt-3">No Available Schedules</h3>
        <p class="text-muted">There are currently no available trips to book. Please check back later.</p>
        <a href="/user/<%= user.id %>/dashboard" class="btn btn-primary">
          <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Filter JavaScript -->
  <script>
    let allSchedules = []; // Store all schedules for filtering

    document.addEventListener('DOMContentLoaded', function() {
      // Populate route filter dropdown
      populateRouteFilter();
      
      // Store all schedules for filtering
      storeAllSchedules();
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('journeyDate').value = today;
      
      // Check if a specific route is selected from dashboard
      const selectedRouteId = '<%= selectedRouteId || "" %>';
      if (selectedRouteId) {
        console.log('Auto-selecting route from dashboard:', selectedRouteId);
        
        // Find the route information for the selected route
        const selectedRouteCard = document.querySelector(`[data-route-id="${selectedRouteId}"]`);
        if (selectedRouteCard) {
          const routeNumber = selectedRouteCard.getAttribute('data-route-number');
          
          // Set the route filter
          document.getElementById('routeFilter').value = routeNumber;
          
          // Apply filters to show only schedules for this route
          setTimeout(() => {
            applyFilters();
          }, 100);
          
          // Expand the filter section to show the applied filter
          const filterSection = new bootstrap.Collapse(document.getElementById('filterSection'), {
            show: true
          });
          
          // Update the page title to indicate route-specific selection
          const pageTitle = document.querySelector('h2');
          if (pageTitle) {
            pageTitle.innerHTML = `<i class="bi bi-geo-alt"></i> Select Schedule for Route ${routeNumber}`;
          }
        }
      }
    });

    function populateRouteFilter() {
      const routeFilter = document.getElementById('routeFilter');
      const routeCards = document.querySelectorAll('.route-card[data-route-number]');
      const routes = new Set();
      
      routeCards.forEach(card => {
        const routeNumber = card.getAttribute('data-route-number');
        const routeName = card.querySelector('.card-title').textContent.trim();
        routes.add(JSON.stringify({number: routeNumber, name: routeName}));
      });
      
      routes.forEach(routeStr => {
        const route = JSON.parse(routeStr);
        const option = document.createElement('option');
        option.value = route.number;
        option.textContent = `${route.number} - ${route.name}`;
        routeFilter.appendChild(option);
      });
    }

    function storeAllSchedules() {
      const scheduleCards = document.querySelectorAll('.schedule-card');
      allSchedules = Array.from(scheduleCards).map(card => {
        return {
          element: card,
          routeNumber: card.closest('.route-card').getAttribute('data-route-number'),
          routeName: card.closest('.route-card').querySelector('.card-title').textContent.trim(),
          departure: card.getAttribute('data-departure-time'),
          arrival: card.getAttribute('data-arrival-time'),
          fare: parseFloat(card.getAttribute('data-fare')),
          availableSeats: parseInt(card.getAttribute('data-available-seats')),
          capacity: parseInt(card.getAttribute('data-capacity')),
          journeyDate: card.getAttribute('data-journey-date') || new Date().toISOString().split('T')[0]
        };
      });
    }

    function applyFilters() {
      const filters = {
        journeyDate: document.getElementById('journeyDate').value,
        departureFrom: document.getElementById('departureTimeFrom').value,
        departureTo: document.getElementById('departureTimeTo').value,
        route: document.getElementById('routeFilter').value,
        minSeats: parseInt(document.getElementById('minSeats').value) || 1,
        maxFare: parseFloat(document.getElementById('maxFare').value) || Infinity,
        sortBy: document.getElementById('sortBy').value
      };

      console.log('Applying filters:', filters);

      // Filter schedules
      let filteredSchedules = allSchedules.filter(schedule => {
        // Date filter (simplified for now as we don't have journey dates in current data)
        
        // Departure time range filter
        if (filters.departureFrom && schedule.departure < filters.departureFrom) {
          return false;
        }
        if (filters.departureTo && schedule.departure > filters.departureTo) {
          return false;
        }

        // Route filter
        if (filters.route && schedule.routeNumber !== filters.route) {
          return false;
        }

        // Minimum seats filter
        if (schedule.availableSeats < filters.minSeats) {
          return false;
        }

        // Maximum fare filter
        if (schedule.fare > filters.maxFare) {
          return false;
        }

        return true;
      });

      // Sort schedules
      filteredSchedules.sort((a, b) => {
        switch (filters.sortBy) {
          case 'fare':
            return a.fare - b.fare;
          case 'seats':
            return b.availableSeats - a.availableSeats;
          case 'departure':
          default:
            return a.departure.localeCompare(b.departure);
        }
      });

      // Hide all schedule cards first
      allSchedules.forEach(schedule => {
        schedule.element.style.display = 'none';
        const routeCard = schedule.element.closest('.route-card');
        routeCard.style.display = 'none';
      });

      // Show filtered schedules and their parent route cards
      const visibleRoutes = new Set();
      filteredSchedules.forEach(schedule => {
        schedule.element.style.display = 'block';
        const routeCard = schedule.element.closest('.route-card');
        routeCard.style.display = 'block';
        visibleRoutes.add(schedule.routeNumber);
      });

      // Update results count and status
      updateResultsDisplay(filteredSchedules.length, filters);

      // Show no results message if needed
      showNoResultsMessage(filteredSchedules.length);
    }

    function clearFilters() {
      // Reset all filter inputs
      document.getElementById('filterForm').reset();
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('journeyDate').value = today;
      
      // Show all schedules
      allSchedules.forEach(schedule => {
        schedule.element.style.display = 'block';
        const routeCard = schedule.element.closest('.route-card');
        routeCard.style.display = 'block';
      });

      // Update display
      updateResultsDisplay(allSchedules.length, {});
      hideNoResultsMessage();
    }

    function updateResultsDisplay(count, filters) {
      const resultsCount = document.getElementById('resultsCount');
      const filterStatus = document.getElementById('filterStatus');
      
      resultsCount.textContent = `${count} bus${count !== 1 ? 'es' : ''} available`;
      
      // Generate filter status text
      let statusParts = [];
      if (filters.journeyDate) statusParts.push(`Date: ${formatDate(filters.journeyDate)}`);
      if (filters.departureFrom || filters.departureTo) {
        let timeRange = 'Time: ';
        if (filters.departureFrom) timeRange += `from ${formatTime(filters.departureFrom)}`;
        if (filters.departureTo) timeRange += ` to ${formatTime(filters.departureTo)}`;
        statusParts.push(timeRange);
      }
      if (filters.route) statusParts.push(`Route: ${filters.route}`);
      if (filters.minSeats && filters.minSeats > 1) statusParts.push(`Min seats: ${filters.minSeats}`);
      if (filters.maxFare && filters.maxFare !== Infinity) statusParts.push(`Max fare: ₹${filters.maxFare}`);
      
      if (statusParts.length > 0) {
        filterStatus.textContent = `Filtered by: ${statusParts.join(', ')}`;
      } else {
        filterStatus.textContent = 'Showing all available buses';
      }
    }

    function showNoResultsMessage(count) {
      let noResultsDiv = document.getElementById('noResultsMessage');
      
      if (count === 0) {
        if (!noResultsDiv) {
          noResultsDiv = document.createElement('div');
          noResultsDiv.id = 'noResultsMessage';
          noResultsDiv.className = 'alert alert-info text-center';
          noResultsDiv.innerHTML = `
            <i class="bi bi-info-circle me-2"></i>
            <strong>No buses found matching your criteria.</strong><br>
            <small>Try adjusting your filters or clearing them to see more options.</small>
          `;
          document.querySelector('.container').appendChild(noResultsDiv);
        }
        noResultsDiv.style.display = 'block';
      }
    }

    function hideNoResultsMessage() {
      const noResultsDiv = document.getElementById('noResultsMessage');
      if (noResultsDiv) {
        noResultsDiv.style.display = 'none';
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function formatTime(timeString) {
      const [hours, minutes] = timeString.split(':');
      const date = new Date();
      date.setHours(parseInt(hours), parseInt(minutes));
      return date.toLocaleTimeString('en-IN', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // Auto-apply filters when date changes
    document.getElementById('journeyDate').addEventListener('change', function() {
      applyFilters();
    });
  </script>

  <!-- Booking Selection JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectButtons = document.querySelectorAll('.select-schedule');
      
      selectButtons.forEach(button => {
        button.addEventListener('click', function() {
          const scheduleId = this.dataset.scheduleId;
          
          // Store selected schedule data in sessionStorage for the booking form
          const scheduleData = {
            scheduleId: scheduleId,
            routeNumber: this.dataset.routeNumber,
            origin: this.dataset.origin,
            destination: this.dataset.destination,
            fare: this.dataset.fare,
            date: this.dataset.date,
            departure: this.dataset.departure,
            arrival: this.dataset.arrival,
            availableSeats: this.dataset.availableSeats,
            busNumber: this.dataset.busNumber,
            driver: this.dataset.driver
          };
          
          sessionStorage.setItem('selectedSchedule', JSON.stringify(scheduleData));
          
          // Redirect to booking form
          window.location.href = `/user/<%= user.id %>/bookings/form?schedule=${scheduleId}`;
        });
      });
    });
  </script>
</body>
</html>